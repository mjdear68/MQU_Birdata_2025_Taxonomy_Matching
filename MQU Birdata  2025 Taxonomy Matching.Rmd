---
title: "MQU Birdata 2025 Taxonomy Matching"
author: "Michael Dear"
date: "2025-07-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This project aims to match the Birdata (BD) taxonomy to the Atlas of Living Australia (ALA) taxonomy. The scope is all bird species identified in either BD or ALA for the given study area. The overall goal is to produce a dataset in which BD data is incorporated into the ALA data using ALA scientific and common names.

## Method

An iterative approach is taken to matching. Exact matches on either scientific name or common name are resolved first. The residual records are matched using approximate matching techniques. BD is taken as the source and is matched against ALA. A translation table is produced in which BD names are matched against ALA names. The translation table is tested on a subset of BD data and reviewed for accuracy.

## Data Sources

### Birdata

Species names for a KBA can be obtained from BD (<https://birdata.birdlife.org.au/>) by 

* Select 'Key Biodiversity Areas' in 'Area Layer' in the left panel 
* Select the relevant KBA in 'Area' 
* Leave all other settings as defaults 
* Click the download icon next to 'Species List' in the right panel 
* Repeat this process for each KBA 
* Rename the files to identify them with their respective KBAs 
* Move the files into the './Input/BD' folder in this project

### ALA

Species names for a KBA can be obtained from ALA (<https://ala.org.au/>) by 

* Opening the 'Spatial Analysis' from the 'Search and Analyse' menu at the top of the home page 
* Upload the shape file for a KBA from the './Shapefiles' directory in this project 
* Open 'Area Report - interactive' from the 'Tools' menu at the top of the left panel 
* Scroll down and click the 'List' button next 'Birds' 
* Click the 'Download' button once the list opens 
* Repeat this process for each KBA 
* Rename the files to identify them with their respective KBAs 
* Move the files into the './Input/ALA' folder in this project

## References

* "Fuzzy Matching in R (Example) \| Approximate String, Name & Text Search \| adist(), agrep() & amatch()", <https://youtu.be/txHkNr29w20?si=XSQiEHiplcBrwc0x>, for approximate matching using `stringdist::amatch`

# Setup

```{r libraries, parameters, etc}
# Clear the environment
rm(list=ls())

# Libraries
library(stringdist)
library(tidyverse)
```

## Custom Functions

Function to give a data frame summary, structure, missing values, and number of duplicates in each column.

```{r funtion to print data frame information}
# Need to use cat() not print() for newlines; https://stackoverflow.com/a/4072218/8299958
df_info <- function(df){
  cat("Summary:\n")
  print(summary(df))
  cat("\n") 
  cat("Structure:\n")
  str(df)
  cat("\n")
  cat("NA:\n")
  print(sapply(df, function(x) sum(is.na(x))))
  cat("\n")
  cat("Duplicates (ignoring NA):\n")
  print(sapply(df, function(x) sum(duplicated(na.omit(x)))))
}
```

Function to read a directory of delimited files into a data frame.

```{r function to read a directory of delimited files into a data frame}
readDIR <- function(path, 
                    skip=0, 
                    delim=",",
                    cols,
                    na_strings=c("", "NA"),
                    str_replace_pattern=c(" " = "_", "-" = "_", "\\[" = "", "\\]" = "")
){
  # Read the directory of files
	list_of_files <- list.files(path = path,
		recursive = TRUE,
		pattern = "\\.csv$",
		full.names = TRUE)
	
	out <- lapply(list_of_files, function(x){
  	  df <- read_delim(x, delim=delim, skip=skip, na = na_strings, 
  	                   name_repair = function(n){str_replace_all(n, str_replace_pattern)})
  	  df <- df |> select(cols)
	  }) |>
	    bind_rows() |> distinct() # Collapse list into a single data frame
	
	return(out)
}
```

# Data Preparation

Read the directories of CSV's into data frames.

```{r read in the species files}
BD_species <- readDIR(path="./Input/BD/", cols=c(1:2)) |> relocate(2,1)

ALA_species <- readDIR(path="./Input/ALA/", cols=c("Species_Name", "Vernacular_Name")) |> rename("Scientific_Name"="Species_Name", "Common_Name"="Vernacular_Name")
```

```{r}
df_info(BD_species)
df_info(ALA_species)
```

# Match Taxonomies

## Exact Match - Scientific Name

```{r Matching level 1}
# new_name = old_name
new_col_names <- c("Scientific_Name_BD"="Scientific_Name.x", 
                   "Common_Name_BD"="Common_Name.x",
                   "Scientific_Name_ALA"="Scientific_Name.y", 
                   "Common_Name_ALA"="Common_Name.y")

lev1 <- left_join(BD_species, 
                ALA_species, 
                by="Scientific_Name", 
                keep = TRUE) |>
    rename(all_of(new_col_names))

# Matched records
lev1_match <- lev1 |> filter(!is.na(Scientific_Name_ALA)) |>
  mutate(Match_Type = "Exact - Scientific Name")
lev1_resid <- lev1 |> filter(is.na(Scientific_Name_ALA)) # Unmatched records; pass to next level

# Print information about the data frames
df_info(lev1)
df_info(lev1_match)
df_info(lev1_resid)
```

## Exact Match - Common Name

```{r matching level 2}
lev2 <- left_join(lev1_resid, 
                ALA_species, 
                by = c("Common_Name_BD" = "Common_Name"),
                keep = TRUE) |>
  select("Scientific_Name_BD", "Common_Name_BD", "Scientific_Name", "Common_Name") |>
  rename("Scientific_Name_ALA" = "Scientific_Name", "Common_Name_ALA" = "Common_Name")

# Matched records
lev2_match <- lev2 |> filter(!is.na(Scientific_Name_ALA)) |>
  mutate(Match_Type = "Exact - Common Name")
lev2_resid <- lev2 |> filter(is.na(Scientific_Name_ALA)) # Unmatched records; pass to next level

# Print information about the data frames
df_info(lev2)
df_info(lev2_match)
df_info(lev2_resid)
```

The length of lev1_resid = 219, whereas length of lev2 = 228, indicating there are some duplicated records. Check for duplicates.

```{r}
df_info(BD_species)
df_info(lev2)

# Data frame of duplicates, ignoring NA
dups <- lev2 |>
  group_by(Scientific_Name_BD) |>
  filter(n() > 1 & !is.na(Scientific_Name_BD)) |>
  ungroup()

dups
```

There are 9 duplicates in Scientific_Name_BD. Manual inspection indicates this is due to the same common name mapping to multiple subspecies in the ALA taxonomy. These Scientific_Name_BD records will need to be reviewed manually and reduced to the appropriate subspecies.

## Approximate Match - Common Name

Approximate matching on scientific name proved ineffective compared with approximate matching on commo name.

```{r matching level 3}
# https://statisticsglobe.com/fuzzy-matching-r

lev3 <- tibble(lev2_resid |> select(Scientific_Name_BD, Common_Name_BD),
       ALA_species[amatch(lev2_resid$Common_Name_BD, ALA_species$Common_Name, maxDist = 5),] |> select(Scientific_Name_ALA = Scientific_Name, Common_Name_ALA = Common_Name)
)


# Matched records
lev3_match <- lev3 |> filter(!is.na(Scientific_Name_ALA)) |>
  mutate(Match_Type = "Approximate - Common Name")
# Unmatched records
lev3_resid <- lev3 |> filter(is.na(Scientific_Name_ALA)) |>
  mutate(Match_Type = "Unmatched")

# Print information about the data frames
df_info(lev3)
df_info(lev3_match)
df_info(lev3_resid)
```

## Collapse to make final translation table

```{r make translation table}
df_trans <- bind_rows(list(lev1_match, lev2_match, lev3_match, lev3_resid))

# Print information about the data frame
df_info(df_trans)
```

## Write to CSV

```{r write to csv}
df_trans |> write.csv("./Output/translation_table.csv", row.names = FALSE)
```

## Manual Checks Required

Open "./Output/translation_table.csv" in a spreadsheet to complete the following checks:

* Review all records with Match_Type = "Approximate - Common Name" and Match_Type = "Unmatched". Drop or re-map the records as required.
* Review all records with duplicated Scientific_Name_BD. Merging the ALA taxonomy into BD data will be inaccurate or fail with duplicates in Scientific_Name_BD.

# Accuracy Assessment
