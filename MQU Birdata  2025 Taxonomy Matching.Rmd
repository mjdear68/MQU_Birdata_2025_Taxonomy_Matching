---
title: "MQU Birdata  2025 Taxonomy Matching"
author: "Michael Dear"
date: "2025-07-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
This project aims to match the Birdata (BD) taxonomy to the Atlas of Living Australia (ALA) taxonomy. The scope is all bird species identified in either BD or ALA for the given study area. The overall goal is to produce a dataset in which BD data is incorporated into the ALA data using ALA scientific and common names.

## Method
An iterative approach is taken to matching. Exact matches on either scientific name or common name are resolved first. The residual records are matched using approximate matching techniques. BD is taken as the source and is matched against ALA. A translation table is produced in which BD names are matched against ALA names. The translation table is tested on a subset of BD data and reviewed for accuracy.

## Data Sources

### Birdata
Species names for a KBA can be obtained from BD (https://birdata.birdlife.org.au/) by
* Select 'Key Biodiversity Areas' in 'Area Layer' in the left panel
* Select the relevant KBA in 'Area'
* Leave all other settings as defaults
* Click the download icon next to 'Species List' in the right panel
* Repeat this process for each KBA 
* Rename the files to identify them with their respective KBAs
* Move the files into the './Input/BD' folder in this project

### ALA
Species names for a KBA can be obtained from ALA (https://ala.org.au/) by
* Opening the 'Spatial Analysis' from the 'Search and Analyse' menu at the top of the home page
* Upload the shape file for a KBA from the './Shapefiles' directory in this project
* Open 'Area Report - interactive' from the 'Tools' menu at the top of the left panel
* Scroll down and click the 'List' button next 'Birds' 
* Click the 'Download' button once the list opens
* Repeat this process for each KBA 
* Rename the files to identify them with their respective KBAs
* Move the files into the './Input/ALA' folder in this project

## References
* "Fuzzy Matching in R (Example) | Approximate String, Name & Text Search | adist(), agrep() & amatch()", https://youtu.be/txHkNr29w20?si=XSQiEHiplcBrwc0x, for approximate matching using `stringdist::amatch` 

# Setup
```{r setup}
# Clear the environment
rm(list=ls())

# Libraries
library(stringdist)
library(tidyverse)
```


# Data Preparation
Read the directories of CSV's into data frames.

```{r function to read a directory of files into a data frame}
readDIR <- function(path, 
                    skip=0, 
                    delim=",",
                    cols,
                    na_strings=c("", "NA"),
                    str_replace_pattern=c(" " = "_", "-" = "_", "\\[" = "", "\\]" = "")
){
  # Read the directory of files
	list_of_files <- list.files(path = path,
		recursive = TRUE,
		pattern = "\\.csv$",
		full.names = TRUE)
	
	out <- lapply(list_of_files, function(x){
  	  df <- read_delim(x, delim=delim, skip=skip, na = na_strings, 
  	                   name_repair = function(n){str_replace_all(n, str_replace_pattern)})
  	  df <- df |> select(cols)
	  }) |>
	    bind_rows() |> distinct() # Collapse list into a single data frame
	
	return(out)
}
```

```{r read in the species files}
BD_species <- readDIR(path="./Input/BD/", cols=c(1:2)) |> relocate(2,1)

ALA_species <- readDIR(path="./Input/ALA/", cols=c("Species_Name", "Vernacular_Name")) |> rename("Scientific_Name"="Species_Name", "Common_Name"="Vernacular_Name")
```

Check the data frame structures, missing values etc.
```{r data frame check}
summary(BD_species)
str(BD_species)
sapply(colnames(BD_species), function(x) sum(is.na(BD_species[,x])))

summary(ALA_species)
str(ALA_species)
sapply(colnames(ALA_species), function(x) sum(is.na(ALA_species[,x])))

```


# Match Taxonomies
Create columns in BD_species to hold the ALA values for Scientific_Name and Common_Name. Create a column for the type of match: "exact" or "approximate".

```{r BD_species ALA columns}
BD_species <- BD_species |>
  mutate(Scientific_Name_ALA="", Common_Name_ALA="", Match_Type="")
```

Now perform the matching: exact followed by approximate.

## Exact Match - Scientific Name
```{r join 1}
# new_name = old_name
new_col_names <- c("Scientific_Name_BD"="Scientific_Name.x", 
                   "Common_Name_BD"="Common_Name.x",
                   "Scientific_Name_ALA"="Scientific_Name.y", 
                   "Common_Name_ALA"="Common_Name.y")

# Convert to lower case before joining
j1 <- left_join(BD_species |> mutate(across(everything(), str_to_lower)) , 
                ALA_species |> mutate(across(everything(), str_to_lower)), 
                by="Scientific_Name", 
                keep = TRUE) |>
    rename(all_of(new_col_names))

# Matched records
j1_match <- j1 |> filter(!is.na(Scientific_Name_ALA)) |>
  mutate(Match_Type = "Exact - Scientific Name")
j1_resid <- j1 |> filter(is.na(Scientific_Name_ALA)) # Unmatched records; pass to next level
```

## Exact Match - Common Name
```{r join 2}
j2 <- left_join(j1_resid |> mutate(across(everything(), str_to_lower)) , 
                ALA_species |> mutate(across(everything(), str_to_lower)), 
                by = c("Common_Name_BD" = "Common_Name"),
                keep = TRUE) |>
  select("Scientific_Name_BD", "Common_Name_BD", "Scientific_Name", "Common_Name") |>
  rename("Scientific_Name_ALA" = "Scientific_Name", "Common_Name_ALA" = "Common_Name")

# Matched records
j2_match <- j2 |> filter(!is.na(Scientific_Name_ALA)) |>
  mutate(Match_Type = "Exact - Common Name")
j2_resid <- j2 |> filter(is.na(Scientific_Name_ALA)) # Unmatched records; pass to next level
```

## Collapse to make final translation table
```{r make translation table}
l <- list(j1_match, j2_match)

df_trans <- bind_rows(l)
```



# Accuracy Assessment